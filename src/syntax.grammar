@precedence {
  or @left
  and @left
  compare @left
  bitwise @left
  bitShift @left
  add @left
  multiply @left

  else @right
}

@top Program { topLevelItem* }

topLevelItem { Decl }

//// Top level.

Decl { ( FnProto (";" | Block) | VarDecl ) }

FnProto { fn Identifier? "(" ParamDeclList ")" }

VarDecl { ( Const | Var ) Name (":" TypeExpr)?  ";" }

Name { identifier }

//// Block level.

Statement {
  IfStatement
  | labeledStatement
  | (assignExprExclIf | exprExclIf) ";"
}

IfStatement {
  IfPrefix ( blockExpr (!else Else Payload? Statement)?
             | (AssignExpr | Expr) (";" | !else Else Payload? Statement) )
}

labeledStatement { Block | loopStatement }

loopStatement { WhileStatement }

WhileStatement {
  WhilePrefix ( blockExpr (!else Else Payload? Statement)?
                | (AssignExpr | Expr) (";" | !else Else Payload? Statement) )
}

blockExpr { Block }

//// Expression level.

assignExprExclIf { exprExclIf AssignOp Expr }

AssignExpr { Expr AssignOp Expr }

exprExclIf { binaryExprExclIf | primaryExprExclIf }

Expr { BinaryExpr | PrimaryExpr }

binaryExprExclIf {
  exprExclIf !or Or Expr
  | exprExclIf !and And Expr
  | exprExclIf !compare CompareOp Expr
  | exprExclIf !bitwise BitwiseOp Expr
  | exprExclIf !bitShift BitShiftOp Expr
  | exprExclIf !add AdditionOp Expr
  | exprExclIf !multiply MultiplyOp Expr
}

BinaryExpr {
  Expr !or Or Expr
  | Expr !and And Expr
  | Expr !compare CompareOp Expr
  | Expr !bitwise BitwiseOp Expr
  | Expr !bitShift BitShiftOp Expr
  | Expr !add AdditionOp Expr
  | Expr !multiply MultiplyOp Expr
}

PrimaryExpr {
  IfExpr
  | primaryExprExclIf
}

primaryExprExclIf {
  Break
  | Continue
  | Return Expr?
  | CurlySuffixExpr
}

CurlySuffixExpr { TypeExpr }

IfExpr { IfPrefix Expr (!else Else Payload? Expr)? }

Block { "{" Statement* "}" }

TypeExpr { //seq(repeat($.prefix_type_op), choice($.error_union_expr, $._suffix_expr)),
           suffixExpr }

suffixExpr { ( //seq("async", $._primary_type_expr, repeat($._suffix_op), $.fn_call_arguments),
               //seq($._primary_type_expr, repeat(choice($._suffix_op, $.fn_call_arguments))),
               PrimaryTypeExpr ) }

PrimaryTypeExpr {
  Identifier
  | Integer }

//// Fn specific.

ParamDeclList { (ParamDecl ",")* ParamDecl? }

ParamDecl { //seq(optional($.doc_comment), optional(choice("noalias", "comptime")), optional(seq($.identifier, ":")), $.param_type),
            (Identifier ":") ParamType
            | "..." }

ParamType { anytype | TypeExpr }

//// Control flow prefixes

IfPrefix { If "(" Expr ")" PtrPayload? }

WhilePrefix { While "(" Expr ")" PtrPayload? /* while_continue_expr */}

//// Payloads

Payload { "|" Identifier "|" }

PtrPayload { "|" Star? Identifier "|" }

Star { "*" }

//// Operators

CompareOp { "==" | "!=" | ">" | "<" | ">=" | "<=" }

AssignOp { "*=" | "*|=" | "/=" | "%=" | "+=" | "+|=" | "-=" | "-|=" | "<<=" | "<<|=" | ">>=" | "&=" | "^=" | "|=" | "*%=" | "+%=" | "-%=" | "=" }

BitwiseOp { "&" | "^" | "|" | Orelse | Catch Payload? }

BitShiftOp { "<<" } //| ">>" | "<<| }

AdditionOp { "+" | "-" | "++" }

MultiplyOp { "||" } // | "*" } // | "/" | "%" | "**" | "*%" | "*|" }

PrefixOp { "!" | "-" | "~" | "-%" | "&" | "try" | "await" }

////

Identifier { identifier }

@skip { whitespace | LineComment | BlockComment }

@tokens {
  whitespace {
    ($[ \t\r\n] | "\\" "\r"? "\n")+
  }

  And { "and" }
  anytype { "anytype" }
  Break { "break" }
  Catch { "catch" }
  Const { "const" }
  Continue { "continue" }
  Else { "else" }
  fn { "fn" }
  If { "if" }
  Or { "or" }
  Orelse { "orelse" }
  Return { "return" }
  Var { "var" }
  While { "while" }

  Integer { $[0-9]+ }

  //identifier: ($) => choice(/[A-Za-z_][A-Za-z0-9_]*/, seq("@", $.string_literal)),
  identifier {
    $[A-Za-z_] $[A-Za-z0-9_]*
  }

  @precedence { And anytype Break Catch Const Continue Else fn If Integer Or Orelse Return Var While identifier }

  LineComment[isolate] { "//" ("\\" (![\n] | "\\r"? "\\n") | ![\n])* }

  BlockComment[isolate] { "/*" blockCommentRest }

  blockCommentRest { ![*] blockCommentRest | "*" blockCommentAfterStar }

  blockCommentAfterStar { "/" | "*" blockCommentAfterStar | ![/*] blockCommentRest }

  @precedence { LineComment, BlockComment }
}
